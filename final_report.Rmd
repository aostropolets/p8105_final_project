---
title: "Final Report"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: yeti
    include:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(readxl)
library(haven)
library(ggplot2)
library(zipcodeR)
library(ggmap)
library(leaflet)
library(kableExtra)

phrase = "SRTR Multiorgan Transplant Data, August 2020 Release"

suffix = list("age","gender","demographics","blood_type")

for (i in suffix){
  data_path = "./data/old_data/"   # path to the data
  files = dir(data_path, 
              pattern = paste0("csrs_final_tables_2006_[A-Z][A-Z]_", i,".csv"))
  assign(paste0("df_all_", i),
         files %>%
           map(~ read_csv(file.path(data_path, .))%>%
                 mutate(org = str_replace(org, "HR", "Heart"),
                        org = str_replace(org, "HL", "Heart-Lung"),
                        org = str_replace(org, "IN", "Intestine"),
                        org = str_replace(org, "KI", "Kidney"),
                        org = str_replace(org, "KP", "Kidney-Pancreas"),
                        org = str_replace(org, "LI", "Liver"),
                        org = str_replace(org, "LU", "Lung"),
                        org = str_replace(org, "PA", "Pancreas"))) %>%
           reduce(rbind))
  }
```

## Variation in kidney transplantation center practices and patient characteristics

## Group members:  
Kristen King (*kk3154*), Harry Reyes (*hr2479*), Lauren Richter (*lr2854*), Matthew Spotnitz (*mes2165*)

## Motivation

  The Scientific Registry of Transplant Recipients (SRTR) analyzes data on transplant centers, candidates, and recipients from multiple sources.^1^ Its mission is to provide advanced statistical and epidemiological analyses related to solid organ allocation and transplantation in support of the Department of Health and Human Services and its agents in their oversight of the national organ transplantation system.^2^ The SRTR produces annual summary reports on patients who are either recipients of a solid organ transplant or on a waitlist to receive one across all transplant centers in the United States.^3^ They also produce biannual center-level reports that focus on benchmarking individual center performance relative to other centers within administrative boundaries or nationwide. The administrative boundaries used for grouping centers divide the country into 57 different Donation Service Areas (DSAs), which are then aggregated into 11 regions.

  With over 200 different kidney transplant centers across the United States, most patients live within driving distance of at least 2 centers and have some choice in where to seek waitlisting for transplantation.^4,5^ Patients can even be listed simultaneously at multiple centers. The current reports produced by the SRTR compare data from one given center to aggregate data within one DSA and one region; however, these administrative boundaries don’t always represent which centers are geographically proximal to each other. For example, individual transplant centers within New York City are compared to summary data from a group of NYC centers, but not other nearby centers in New Jersey or Connecticut, as they belong to three separate DSAs and three separate regions.

  There is a dramatic shortage of organs for transplant relative to end-stage kidney disease patients in need,^3^ and transplant centers are selective in who to accept onto their waitlist as a candidate for a transplant in order to maximize the benefits from donated organs and ensure patients will not be put at risk from major surgery and lifelong immunosuppression medications if the risks outweigh the potential benefits of receiving a transplant. There is also large variation between centers in which donor organs they will accept for transplant that can influence patients’ likelihood of receiving a transplant, and how quickly.^6,7^ Patients may be interested in comparing demographic and outcomes data at all of the centers geographically closest to them to understand where they might have the best chance at receiving a successful transplant, regardless of the administrative boundaries currently used.

  From a research perspective, there is also great value in being able to look at data across all centers nationwide and over time in order to explore differences in practice patterns across centers and how it may correlate to patient outcomes. The extensive data that is compiled by the SRTR to produce their reports is all publicly available on their website, but not in a particularly user-friendly format. The full reports can be downloaded in PDF format for one center and time period at a time, and limited pieces of the most current information are displayed within web pages, one center at a time. The underlying data can also be downloaded in very large excel files with rows for all centers, for one organ and one given time period at a time, across many different sheets of data. The aims of this project were to (1) automate the retrieval and compilation of the archived data across all time periods to create a repository that could be used for future research, (2) explore the data available to select and clean the most relevant data elements, and (3) create a dashboard with data visualizations that may be of interest to patients looking to compare transplant centers based on geographical proximity rather than arbitrary administrative boundaries. 


## Related Work

  The SRTR website currently has a search function that allows a user to type in a zip code and see a list of transplant centers within a given number of miles, and to rank them by distance, number of transplants performed, or a 5-level rating of likelihood of getting a transplant faster or 1-year kidney survival.^8^ While these are important high-level summary data, the user must click to download and scroll through multiple long PDF files in order to perform any other more detailed comparisons between centers. Additionally, while there has historically been intense regulatory scrutiny on 1-year post-transplant outcomes, prior work has shown that patients are actually more interested in waitlist outcomes.^9,10^
Prior research by one team member involved working with Offer Acceptance Ratio data from the SRTR reports and was limited to data from one time period only due to the logistical difficulty in downloading and wrangling these data. While geographic variation in access to transplantation has historically been attributed to variability in local organ supply relative to waitlist demand,^11,12^ this work found that there is significant variation in the probability of transplantation across centers within a DSA, which share a local organ supply. Offer Acceptance Ratios, which measure how frequently transplant centers accept the organ offers they receive relative to other centers nationwide, stratified by donor risk level, were found to be correlated with the likelihood of transplantation.^13^ Prior work also demonstrates that many patients die on the waitlist after having multiple organ offers that were declined on their behalf, with organ quality the most frequent reason for decline rather than a patient-specific reason.^14^ Together, these findings suggest that centers’ organ offer acceptance behavior, especially for higher-risk kidneys which frequently end up discarded after too many declines, has important impact on patient outcomes and need to be studied further. Understanding variability in practice between centers may help identify opportunities to share best practices and ultimately improve access to transplantation for patients.
 

## Initial questions

  We first wanted to use the SRTR report data to understand how patient demographics varied at centers across the country, for both waitlisted candidates and transplant recipients. We wanted to present distributions of demographic characteristics for both candidates and recipients side-by-side to allow for visual comparison. Variables considered in initial analyses included age, race, sex, and blood type. We later expanded our analysis dataset to include additional clinical characteristics such as underlying cause of kidney disease (diabetes, hypertension, glomerulonephritis, polycystic kidney disease, or other/unknown), Body Mass Index (BMI), high Panel Reactive Antibodies (PRA) sensitization, and history of prior transplant. We compared across numeric zip codes as an initial consideration of geographic proximity. While we started with all solid organ transplants (kidney, liver, heart, lung, intestine, and pancreas, plus combinations of multi-organ transplants), we ultimately narrowed the scope of our project to only kidney, which is the most frequently transplanted organ in the United States. 

  We next aimed to assess variation in waitlist outcomes (transplant from a living donor, transplant from a deceased donor, death, or waitlist removal for deteriorating condition) across centers. We also visually examined differences between transplant centers in offer acceptance ratios, across different donor risk levels (low-risk, medium-risk, high-risk, and hard-to-place kidneys that required >100 offers before acceptance). We were also interested in exploring trends over time in centers’ offer acceptance ratios.


## Data

  While the SRTR Program-Specific Reports (PSR) are designed to be accessed primarily as center-specific snapshot PDF files, the data that were used to create these reports are also publicly available from the SRTR website.^15,16^ Data for each biannual reporting period can be downloaded as zip files of excel workbooks for each organ type. Within each organ-specific excel workbook, there is one row for each transplant center, with 28-34 sheets of data corresponding to the various tables and figures in the PDF reports, and tens to hundreds of columns of data within each sheet. Data from 18 reporting time periods were available for download, dated from July 2012 through May 2021. 

  We developed an automated pipeline to download, unzip, filter, compile, and tidy all of the archived data from the URLs, as found in the downloading_data.Rmd file. We inspected the SRTR webpage where the data can be downloaded to file names/dates and URLs that are associated with the drop-down menu options and ‘download’ buttons. We then wrote a function to download both the current data files (accessed as a separate URL format) and each of the archived data releases, unzip the folders of all organs, select only the kidney files, and compile all years of data into one nested list with list columns. We wrote additional functions to select only the variables of interest for analysis from the various sheets to reduce the working file size. The number of sheets of data, the sheet names, and the variable names changed over time and required extensive tidying and reconciling for merging. For example, data on age group changed from using a “65+” category to further breaking it down to “65-69” and “70+”, and the name of the sheet where these data were found changed from “Table 1” to “Table B1” over time. 

	
## Exploratory Analyses
*	Histogram of kidney transplant center frequency by zipcode.
*	Leaflet plot of kidney transplant centers by zipcode.
*	Histogram of kidney transplant waitlist patient outcomes by zipcode (i.e. mortality, transfer, etc.).
*	Automated exploratory data analysis that was iterated over other organ types.

## Additional Analyses
*	Scatter plots of demographics, age, gender, blood type, and comorbidities for kidney transplant waitlist patients by zipcode.
*	Scatter plots of PRA score with comorbidities yielded no major correlations.
*	Scatter plots of patient characteristics with facet wrap by organ type.

#### Figure X: Histogram of Kidney Transplant Center by Zipcode
```{r}
df_one_names = 
  read_excel("./data/csrs_final_tables_2006_KI.xls", sheet = "Table B1") %>%
  janitor::clean_names()%>%
  rename(
    newlistings_center_time1 = wla_addcen_nc1, 
    newlistings_center_time2 = wla_addcen_nc2, 
    newlistings_center_all = wla_addcen_pcz,
    newlistings_regional = wla_addcen_prz, 
    newlistings_usa = wla_addcen_puz,
    endlistings_center_time1 = wla_end_nc1, 
    endlistings_center_time2 = wla_end_nc2, 
    endlistings_center_all = wla_end_pcz, 
    endlistings_regional = wla_end_prz, 
    endlistings_usa = wla_end_puz,
    deteriorated_center_time1 = wla_remdet_nc1, 
    deteriorated_center_time2 = wla_remdet_nc2, 
    deteriorated_center_all = wla_remdet_pcz, 
    deteriorated_regional = wla_remdet_prz, 
    deteriorated_usa = wla_remdet_puz,
    died_center_time1 = wla_remdied_nc1, 
    died_center_time2 = wla_remdied_nc2, 
    died_center_all = wla_remdied_pcz, 
    died_regional = wla_remdied_prz, 
    died_usa = wla_remdied_puz,
    other_center_time1 = wla_remoth_nc1, 
    other_center_time2 = wla_remoth_nc2, 
    other_center_all = wla_remoth_pcz, 
    other_regional = wla_remoth_prz, 
    other_usa = wla_remoth_puz,
    recovered_center_time1 = wla_remrec_nc1, 
    recovered_center_time2 = wla_remrec_nc2, 
    recovered_center_all = wla_remrec_pcz, 
    recovered_regional = wla_remrec_prz, 
    recovered_usa = wla_remrec_puz,
    transfer_center_time1 = wla_remtfer_nc1, 
    transfer_center_time2 = wla_remtfer_nc2, 
    transfer_center_all = wla_remtfer_pcz, 
    transfer_regional = wla_remtfer_prz, 
    transfer_usa = wla_remtfer_puz,
    deceased_donor_center_time1 = wla_remtxc_nc1, 
    deceased_donor_center_time2 = wla_remtxc_nc2, 
    deceased_donor_center_all = wla_remtxc_pcz, 
    deceased_donor_regional = wla_remtxc_prz, 
    deceased_donor_usa = wla_remtxc_puz,
    living_donor_center_time1 = wla_remtxl_nc1, 
    living_donor_center_time2 = wla_remtxl_nc2, 
    living_donor_center_all = wla_remtxl_pcz, 
    living_donor_regional = wla_remtxl_prz, 
    living_donor_usa = wla_remtxl_puz,
    transplant_other_center_time1 = wla_remtxoc_nc1, 
    transplant_other_center_time2 = wla_remtxoc_nc2, 
    transplant_other_center_all = wla_remtxoc_pcz, 
    transplant_other_regional = wla_remtxoc_prz, 
    transplant_other_center_usa = wla_remtxoc_puz,
    start_waitlist_center_time1 = wla_st_nc1, 
    start_waitlist_center_time2 = wla_st_nc2, 
    start_waitlist_center_all = wla_st_pcz, 
    start_waitlist_regional = wla_st_prz, 
    start_waitlist_usa = wla_st_puz)

# Tidy data
# Here we delete an extraneous row, drop missing values, and 
# convert the appropriate columns from character to numeric.

df_one_names = 
  df_one_names[-c(1), ]
df_one_names[, c(4,6:60)] <- sapply(df_one_names[, c(4,6:60)], as.numeric)
df_one_dropna = drop_na(df_one_names) #3 rows were dropped

df_one_plot = 
  df_one_dropna %>%  # Here we drop missing values and create derived values.
  mutate(
    newlistings_percent_mortality = 100*died_center_all/newlistings_center_all, 
    newlistings_percent_deteriorated = 100*deteriorated_center_all/newlistings_center_all,
    newlistings_percent_transfer = 100* transfer_center_all/newlistings_center_all,
    newlistings_percent_living_donor = 100* living_donor_center_all/newlistings_center_all,
    newlistings_percent_deceased_donor = 100*deceased_donor_center_all/newlistings_center_all,
    newlistings_percent_recovered = 100* recovered_center_all/newlistings_center_all, 
    living_deceased_graft_ratio = living_donor_center_all/deceased_donor_center_all)

# Here we read in, tidy, and merge with the zipcode file.
df_zipcodes = 
  read_excel("./data/old_data/zipcodes.xlsx", col_types = c("text", "numeric"), skip = 1) %>%
  janitor::clean_names()

# Now we cross reference the coordinates that correspond with each zipcode. 
for (zipcode in df_zipcodes["zipcode"]){
    df_zip_geo = tibble(geocode_zip(zipcode))
}

df_one_merge = 
  merge(df_zipcodes, df_zip_geo, all = TRUE) %>%
  merge(., df_one_plot, all = TRUE)

df_one_merge %>% 
  ggplot(aes(zipcode)) + 
  geom_histogram(bins = 50) + 
  labs(title = "Transplant Center Frequency by Zipcode",
       subtitle = "SRTR Kidney Transplant Data, August 2020 Release",
       x = "Zipcode",
       y = "Transplant Center Count") +
  theme_minimal()

#png('txp_frequency.png')
```

#### Figure X: Geographic distribution of kidney transplant centers across the United States.

```{r}
# leaflet(options = leafletOptions(minZoom = 0, maxZoom = 18))
df_one_merge %>%
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(lat = ~lat, lng = ~lng)

#df = data.frame(Lat = 1:10, Long = rnorm(10))
#leaflet(df) %>% addCircles()
```

#### Figure X: Representative histogram of exposure variables, Kidney Transplant Population.

```{r}
x2 = df_one_merge[, c(21:35)]
plot = ggplot(gather(x2), aes(value)) + 
  geom_histogram(bins = 100) + 
  facet_wrap(~key, scales = "free_y") +
  coord_cartesian(xlim = c(0, 100)) + 
  labs(title = "Exposure Frequency Part2", 
       subtitle = "SRTR Kidney Transplant Data, August 2020 Release", 
       x = "Exposure (Number)", y = "Frequency") + 
  theme_minimal()

plot
```

### Figure X: Representative histogram of patient outcome frequency variables.

```{r}
df_outcomes = 
  df_one_merge %>%
  select(newlistings_percent_mortality, 
         newlistings_percent_deteriorated,
         newlistings_percent_transfer,
         start_waitlist_center_time2,
         start_waitlist_center_all, 
         start_waitlist_regional, 
         start_waitlist_usa) %>%
  filter(newlistings_percent_transfer <= 100)

plot = 
  ggplot(gather(df_outcomes), aes(value)) + 
  geom_histogram(bins = 30) + 
  facet_wrap(~key, scales = "free_y") + 
  coord_cartesian(xlim = c(0, 100)) + 
  labs(title = "Outcome Frequency", 
       subtitle = "SRTR Kidney Transplant Data, August 2020 Release", 
       x = "Outcome (Percent)", y = "Frequency") + 
  theme_minimal()

# df_continuous = sapply(df_outcomes, as.numeric)

plot
```

#### Figure X: Scatter plots of age by zipcode, with a facet wrap by organ type.

```{r age_by_zip, warning=FALSE}
plot = 
  df_all_age %>% 
  ggplot(aes(x = zipcode, y = age_category_percent, color = age_category)) + 
  geom_point() + 
  labs(title = "Patient Age Groups by Zipcode",
       subtitle = phrase,
       x = "Zipcode",
       y = "Age Group (Percent)",
       color = "Age Group") + 
  theme_minimal() + 
  theme(axis.text.x=element_text(angle=90, hjust=1)) + 
  scale_color_hue(labels = c("Less Than 2 Years", "2 to 11 Years", 
                             "12 to 17 Years", "18 to 34 Years", 
                             "35 to 49 Years", "50 to 64 Years", 
                             "65 to 69 Years", "More Than 70 Years")) + 
  facet_wrap(~org)

plot
```

#### Figure X: Scatter plots of gender by zipcode, with a facet wrap by organ type.

```{r gender_by_zip, warning=FALSE}
plot = 
  df_all_gender %>% 
  ggplot(aes(x=zipcode, y =gender_category_percent, color = gender_category)) + 
  geom_point()+ 
  labs(title = "Patient Gender by Zipcode", 
       subtitle = phrase,
       x = "Zipcode",
       y = "Gender (Percent)", color = "Gender"
  ) + 
  theme_minimal() + 
  theme(axis.text.x=element_text(angle=90, hjust=1)) + 
  scale_color_hue(labels = c("Female", "Male")) + 
  facet_wrap(~org)

plot
```

#### Figure X: Scatter plots of race by zipcode, with a facet wrap by organ type.

```{r race_by_zip, warning=FALSE}
plot = 
  df_all_demographics %>% 
  ggplot(aes(x=zipcode, y =race_category_percent, color = race_category)) + 
  geom_point() + 
  theme_minimal() + 
  labs(
    title = "Patient Demographics by Zipcode", subtitle = phrase,
    x = "Zipcode",
    y = "Race (Percent)", 
    color = "Race") + 
  scale_color_hue(labels = c("African American", "Asian", "Hispanic or Latino", 
                             "Other", "Unknown", "White")) + 
  theme(axis.text.x=element_text(angle=90, hjust=1)) + 
  facet_wrap(~org)

plot
```

#### Figure X: Scatter plots of blood type by zipcode, with a facet wrap by organ type.

```{r bloodtype_by_zip, warning=FALSE}
plot = 
  df_all_blood_type %>%
  ggplot(aes(x = zipcode, y = blood_type_category_percent, color = blood_type_category)) + 
  geom_point() + 
  labs(title = "Patient Blood Types by Zipcode", 
       subtitle = "SRTR Kidney Transplant Data, August 2020 Release",
       x = "Zipcode",
       y = "Blood Type (Percent)", color = "Blood Type") + 
  theme_minimal() + 
  scale_color_hue(labels = c("A", "AB", "B", "O", "Unknown")) + 
  theme(axis.text.x=element_text(angle=90, hjust=1)) + 
  facet_wrap(~org)

plot
```

#### Figure X: Screenshot of interactive dashboard for patient characteristics by organ.

![](./img/dashboard_screenshot.png)

*	The proportion of Hispanic or Latino patients was greatest in the southwest zipcodes for all organ types
*	Preponderance of men in waitlist population, especially for heart, kidney and liver transplants
*	Kidney had the highest proportion of children under the age of 2.
*	Kidney-pancreas and intestine had the lowest proportion of patients over the age of 50.

*	Type O was the most common blood type for all kinds of organ transplants
*	Dashboard of waitlist patient characteristics for different organ type.

## Discussion
*	Some variation in waitlist patient characteristics by zipcode, consistent with the demographics of the region.
*	Minimal variance in waitlist patient outcomes by zipcode is reflective of a highly regulated practice.
*	Variation in patient characteristics by organ is consistent with practice guidelines.
	
## References:
1.	Leppke S, Leighton T, Zaun D et al. Scientific Registry of Transplant Recipients: Collecting, analyzing, and reporting data on transplantation in the United States. Transplantation Reviews, (2013) 27(2):50-56
2.	https://www.srtr.org/about-the-data/the-srtr-database/
3.	Hart A, Lentine KL, Smith JM et al. OPTN/SRTR 2019 Annual Data Report: Kidney. American Journal of Transplantation, (2021) 21(S2):21-137. doi: 10.1111/ajt.16502
4.	Sonnenberg EM, Cohen JB, Hsu JY et al. Association of Kidney Transplant Center Volume With 3-Year Clinical Outcomes. American Journal of Kidney Diseases, (2019) 74(4):441-451. doi: 10.1053/j.ajkd.2019.02.019
5.	Schaffhausen CR, Bruin MJ, McKinney WT et. al. How patients choose kidney transplant centers: A qualitative study of patient experiences. Clinical Transplantation, (2019) 33(5):e13523. doi: 10.1111/ctr.13523
6.	Brennan C, Husain SA, King KL et al. A Donor Utilization Index to Assess the Utilization and Discard of Deceased Donor Kidneys Perceived as High Risk. Clinical Journal of the American Society of Nephrology, (2019) 14(11):1634-1641. doi: 10.2215/CJN.02770319
7.	Garonzik-Wang JM, James NT, Weatherspoon KC et al. The Aggressive Phenotype: Center-Level Patterns in the Utilization of Suboptimal Kidneys. American Journal of Transplantation, (2012) 12(2): 400-408. doi: 10.1111/j.1600-6143.2011.03789.x
8.	https://www.srtr.org/transplant-centers/?organ=kidney&recipientType=adult&query=10032
9.	Schold J, Patzer RE, Pruett TL et al. Quality Metrics in Kidney Transplantation: Current Landscape, Trials and Tribulations, Lessons Learned, and a Call for Reform. American Journal of Kidney Diseases, (2019) 74(3):382-389. doi: 10.1053/j.ajkd.2019.02.020
10.	Husain SA, Brennan C, Michelson A et al. Patients Prioritize Waitlist Over Posttransplant Outcomes When Evaluating Kidney Transplant Centers. American Journal of Transplantation, (2018) 18(11): 2781-2790. doi: 10.1111/ajt.14985
11.	Zhou S, Massie AB, Luo X et al. Geographic Disparity in Kidney Transplantation Under KAS. American Journal of Transplantation, (2018) 18(6): 1415-1423. doi: 10.1111/ajt.14622
12.	Mathur AK, Ashby VB, Sands RL et al. Geographic Variation in End-Stage Renal Disease Incidence and Access to Deceased Donor Kidney Transplantation. American Journal of Transplantation, (2010) 10(4 Pt 2):1069-80. doi: 10.1111/j.1600-6143.2010.03043.x
13.	King KL, Husain SA, Schold JD et al. Major Variation across Local Transplant Centers in Probability of Kidney Transplant for Wait-Listed Patients. Journal of the American Society of Nephrology, (2020) 13(12): 2900-2911. doi: 10.1681/ASN.2020030335
14.	Husain SA, King KL, Pastan S et al. Association Between Declined Offers of Deceased Donor Kidney Allograft and Outcomes in Kidney Transplant Candidates. JAMA Network Open, (2019) 2(8):e1910312. doi: 10.1001/jamanetworkopen.2019.10312
15.	https://www.srtr.org/transplant-centers/ny-presbyterian-hospitalcolumbia-univ-medical-center-nycp/?organ=kidney&recipientType=adult
16.	https://www.srtr.org/reports/program-specific-reports/


