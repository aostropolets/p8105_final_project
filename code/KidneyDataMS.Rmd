---
title: "KidneyDataMS"
author: "Matthew Spotnitz"
date: "10/26/2021"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(haven)
library(ggplot2)
library(zipcodeR)
library(ggmap)
library(leaflet)
library(kableExtra)
```

#Import and view.

I will import the kidney data set, clean its column names, and examine the structure, head, and tail of the data set. Then, I will view the data set.
```{r, echo = TRUE}
df_one = read_excel("../data/csrs_final_tables_2006_KI.xls", sheet = "Table B1")
df_one = janitor::clean_names(df_one)
str(df_one)
head(df_one)
tail(df_one)
view(df_one)
```

#Change column names
I will change the column names to more intuitive ones
```{r}
df_one_names = df_one %>% rename(newlistings_center_time1 = wla_addcen_nc1, newlistings_center_time2 = wla_addcen_nc2, newlistings_center_all = wla_addcen_pcz,newlistings_regional = wla_addcen_prz, newlistings_usa = wla_addcen_puz)  %>% rename( endlistings_center_time1 = wla_end_nc1, endlistings_center_time2 = wla_end_nc2, endlistings_center_all = wla_end_pcz, endlistings_regional = wla_end_prz, endlistings_usa = wla_end_puz) %>% rename(deteriorated_center_time1 = wla_remdet_nc1, deteriorated_center_time2 = wla_remdet_nc2, deteriorated_center_all = wla_remdet_pcz, deteriorated_regional = wla_remdet_prz, deteriorated_usa = wla_remdet_puz) %>% rename( died_center_time1 = wla_remdied_nc1, died_center_time2 = wla_remdied_nc2, died_center_all = wla_remdied_pcz, died_regional = wla_remdied_prz, died_usa = wla_remdied_puz) %>% rename(other_center_time1 = wla_remoth_nc1, other_center_time2 = wla_remoth_nc2, other_center_all = wla_remoth_pcz, other_regional = wla_remoth_prz, other_usa = wla_remoth_puz) %>% rename( recovered_center_time1 = wla_remrec_nc1, recovered_center_time2 = wla_remrec_nc2, recovered_center_all = wla_remrec_pcz, recovered_regional = wla_remrec_prz, recovered_usa = wla_remrec_puz) %>% rename(transfer_center_time1 = wla_remtfer_nc1, transfer_center_time2 = wla_remtfer_nc2, transfer_center_all = wla_remtfer_pcz, transfer_regional = wla_remtfer_prz, transfer_usa = wla_remtfer_puz) %>% rename(deceased_donor_center_time1 = wla_remtxc_nc1, deceased_donor_center_time2 = wla_remtxc_nc2, deceased_donor_center_all = wla_remtxc_pcz, deceased_donor_regional = wla_remtxc_prz, deceased_donor_usa = wla_remtxc_puz) %>% rename(living_donor_center_time1 = wla_remtxl_nc1, living_donor_center_time2 = wla_remtxl_nc2, living_donor_center_all = wla_remtxl_pcz, living_donor_regional = wla_remtxl_prz, living_donor_usa = wla_remtxl_puz) %>% rename(transplant_other_center_time1 = wla_remtxoc_nc1, transplant_other_center_time2 = wla_remtxoc_nc2, transplant_other_center_all = wla_remtxoc_pcz, transplant_other_regional = wla_remtxoc_prz, transplant_other_center_usa = wla_remtxoc_puz) %>% rename(start_waitlist_center_time1 = wla_st_nc1, start_waitlist_center_time2 = wla_st_nc2, start_waitlist_center_all = wla_st_pcz, start_waitlist_regional = wla_st_prz, start_waitlist_usa = wla_st_puz) %>% view() 
```
I will delete an extraneous row and drop missing values
```{r}
df_one_names = df_one_names[-c(1), ]
str(df_one_names)
df_one_names[, c(4,6:60)] <- sapply(df_one_names[, c(4,6:60)], as.numeric)
df_one_dropna = drop_na(df_one_names) #3 rows were dropped
str(df_one_dropna)
```
I will drop missing values and create dervived values.
```{r}
df_one_plot = df_one_dropna %>% mutate(newlistings_percent_mortality = 100*died_center_all/newlistings_center_all, newlistings_percent_deteriorated = 100*deteriorated_center_all/newlistings_center_all, newlistings_percent_transfer = 100* transfer_center_all/newlistings_center_all, newlistings_percent_living_donor = 100* living_donor_center_all/newlistings_center_all, newlistings_percent_deceased_donor = 100*deceased_donor_center_all/newlistings_center_all, newlistings_percent_recovered = 100* recovered_center_all/newlistings_center_all, living_deceased_graft_ratio = living_donor_center_all/deceased_donor_center_all)
#view(df_one_plot)
df_one_plot %>% group_by(ctr_cd) %>% ggplot(aes(newlistings_percent_deteriorated)) + geom_histogram()
```
Now, I will read in, tidy, and merge with the zipcode file.
```{r}
df_zipcodes = read_excel("../data/zipcodes.xlsx")
df_zipcodes = df_zipcodes[-c(1), ]
df_zipcodes[, c(2)] = sapply(df_zipcodes[, c(2)], as.numeric)
df_zipcodes = janitor::clean_names(df_zipcodes)
str(df_zipcodes)
head(df_zipcodes)
tail(df_zipcodes)
view(df_zipcodes)
```
Now I will cross reference the coordinates that correspond with each zipcode. 
```{r}
for (zipcode in df_zipcodes["zipcode"]){
    df_zip_geo = tibble(geocode_zip(zipcode))
}
#view(df_zip_geo)
df_geo_merge = merge(df_zipcodes, df_zip_geo, all = TRUE)
view(df_geo_merge)
df_one_merge = merge(df_one_plot, df_geo_merge, all = TRUE)
view(df_one_merge)
```



Now I will map by zipcode
```{r}
df_one_merge %>% ggplot(aes(x = zipcode, y =living_deceased_graft_ratio )) + geom_point()
```
Now I will plot zipcode histogram
```{r}
df_one_merge %>% ggplot(aes(zipcode)) + geom_histogram() + 
  labs(
    title = "Transplant Center Frequency by Zipcode",
    x = "Zipcode",
    y = "Transplant Center Count"
  ) + theme_minimal()
png('txp_frequency.png')
```
Now I will make a leaflet plot of transplant centers in the United States
```{r, eval = FALSE}
library(leaflet)

leaflet(options = leafletOptions(minZoom = 0, maxZoom = 18))
#df = data.frame(Lat = 1:10, Long = rnorm(10))
#leaflet(df) %>% addCircles()
#view(df_one_merge)
m = df_one_merge %>% leaflet() %>% addTiles() %>% addMarkers(lat = ~lat, lng = ~lng)
m
```
Now I will make another leaflet plot of transplant centers in the United States
```{r, eval = FALSE}
library(leaflet)

leaflet(options = leafletOptions(minZoom = 0, maxZoom = 18))
#df = data.frame(Lat = 1:10, Long = rnorm(10))
#leaflet(df) %>% addCircles()
#view(df_one_merge)
m = df_one_merge %>% leaflet() %>% addTiles() %>% addCircleMarkers(lat = ~lat, lng = ~lng, color = ~newlistings_center_all)
m
```
I will now import the data frame from another sheet
```{r}
df_two = read_excel("../data/csrs_final_tables_2006_KI.xls", sheet = "Tables B2-B3 Center")
df_two = janitor::clean_names(df_two)
str(df_two)
head(df_two)
tail(df_two)
view(df_two)
colnames = colnames(df_two)
print(colnames)
```
I will rename and clean the columns for dataframe two.
```{r}
df_two_names = read_excel("../data/B2 names.xlsx")
df_two_names = janitor::clean_names(df_two_names)
df_two_names = df_two_names %>% mutate(c = paste(a,b))
setnames = df_two_names %>% pull(c)
df_two = setNames(df_two, setnames)
df_two = janitor::clean_names(df_two)
df_two_clean = df_two[-c(1), ]
df_two_clean = df_two_clean %>% rename (entire_name= center_name_na , ctr_cd = center_code_na)
view(df_two_clean)
```
I will select and rearrange values in dataframe two
```{r}
df_two_select = df_two_clean %>% select(entire_name, ctr_cd, asian_allc2, african_american_allc2, hispanic_latino_allc2, white_allc2, race_other_allc2, race_unknown_allc2) 
df_social = merge(df_one_merge, df_two_select)
df_social = df_social[, c(1,2, 68, 71:76)]
view(df_social)
knitr::kable(df_social) %>% save_kable("draft_demographics.pdf") 
```