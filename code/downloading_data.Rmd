---
title: "downloading_data"
output: github_document
---

```{r}
library(readxl)
library(rvest)
library(stringr)
library(tidyverse)
library(filesstrings)
```

Creating list of date codes and URLs for the current data file and all archived files.

Dates and URLs came from inspecting this website:
https://www.srtr.org/reports/program-specific-reports/


```{r get_dates}

# archive date format is YYMM, two reports per year
# current year is available with kidney only data, but other years are in .zip

# there was a change in how regions were assigned in 2017
# archive_dates_17 = c("1711", "1808", "1811", "1905", "1911", "2006")

archive_dates = c("1207", "1301", "1307", "1401", "1406", "1412", "1506", "1512", "1606", "1701", "1707", "1711", "1808", "1811", "1905", "1911", "2006")

current_file_date = "2105"

current_file_url = "https://www.srtr.org/assets/media/PSRdownloads/csrs_tables/csrs_final_tables_2105_KI.xls"

url_base = "https://www.srtr.org/assets/media/PSRdownloads/csrs_tables_all/csrs_final_tables_"

# replace with archive_dates to get all years
vec_urls = str_c(url_base, archive_dates, "all.zip")

vec_dates = list(
  date = archive_dates,
  url = vec_urls
)
```

Download the most recent data and save it to /data folder:

```{r download_data}

current_file_path = "../data/csrs_final_tables_2105_KI.xls"

if (!file.exists(current_file_path)) {
  download.file(current_file_url, current_file_path, mode = "wb")
}


# Table B6 - SFL (survival from listing) is a unique table for the recent data
# Removed from analysis because it cannot readily be compared over time

# remove the second unnecessary descriptor line from each excel file

clean_sheets = function(fpath, x) {
  clean_cols = array(readxl::read_xls(fpath, sheet = x, n_max = 1, col_names = FALSE))
  
  clean_sheet = readxl::read_xls(fpath, sheet = x, skip = 2, col_names = FALSE)
  colnames(clean_sheet) = clean_cols
  
  clean_sheet %>%
    janitor::clean_names("all_caps") %>%
    rowwise() %>%
    mutate(ctr_id = ifelse(
      "ctr_cd" %in% colnames(.), 
      paste(ctr_cd, ctr_ty, sep = ""), 
      ifelse("center" %in% colnames(.), center, NA))) %>%
    select(ctr_id, everything())
  
  
  # extract(d1, date_created, c('month', 'day', 'year'),
  #             '([^-]+)-([^-]+)-([^-]+)', remove=FALSE)

  return(clean_sheet)
}

current_data = sapply(readxl::excel_sheets(current_file_path), 
                      simplify = F, 
                      USE.NAMES = T, 
                      function (X) clean_sheets(current_file_path, X)) #%>%
  #within(rm("Table B6 - SFL"))

```

Function to download archived files:

```{r download_archives}

download_archived_data = function(url) {
  
  data_path = "../data/"
  ki_file_pattern = "csrs_final_tables[_1-9]*KI\.[xX][lL][sS]"
  
  grepl(paste(file.path(data_path, ki_file_pattern)))
  
  if (!file.exists(current_file_path)) {
    download.file(current_file_url, current_file_path, mode = "wb")
  }
#Search for pattern in directories:
grepl(paste(file.path(path_root, variable), collapse = "|"), list.dirs(path_root, full.names = TRUE, recursive = FALSE))
  
  # to save to temp folder instead of download, use temp
  temp = tempfile()
  
  download.file(url, temp, mode = "wb")
  
  ki_file = tibble(files = as.character(unzip(temp, list = TRUE)$Name)) %>% 
    filter(str_detect(files, "KI\\.[xX][lL][sS]$"))
  
  ki_filepath = ki_file[[1]]
  
  ki_data = sapply(readxl::excel_sheets(unzip(temp, ki_filepath)), 
                    simplify = F, USE.NAMES = T,
            function(X) clean_sheets(unzip(temp, ki_filepath), X))
  
  
  unlink(temp)
  move_files(ki_filepath, "../data/", overwrite = TRUE)
  
  return(ki_data)
}
```

Compiling all data files (archived and current) into one nested list:

```{r combine_data}

data_all_yrs = map(.x = vec_dates$url, ~download_archived_data(url = .x))

data_all_yrs = append(data_all_yrs, list(current_data))

name_labels = vec_dates$date %>% 
  append(current_file_date)

names(data_all_yrs) = str_c("data_", name_labels)

```

``` {r}

subset_test2 = data_all_yrs[c(1,4,10,length(data_all_yrs))]

subset_test = current_data[c(1,4,5,length(current_data))]

#map(.x = subset_test[everything])

new_df = last(subset_test)

for (i in length(subset_test)) {
   merge(new_df, subset_test[[i]], all = TRUE, suffixes = paste("sheet_",i), suffixes = paste("sheet",i))
}

subset_test
```
Now check to see if the column names are the same across sheets and years

```{r}

# for each sheet in each file
# need to first remove the 1st row after the titles
# check the first column name
# if center -> change name to CTR_CD and CTR_TY


for (i in 1:length(data_all_yrs)) {
  
  data_all_yrs[[i]][["Tiers"]]
  
  add_id_cols = c("Tbls B4-B5 & Fig B1-B6 - All", 
                  "Tbls B4-B5 & Fig B1-B6 - Adult", 
                  "Tbls B4-B5 & Fig B1-B6 - Peds" )
  
  for (sheet_name in add_id_cols) {
    
    data_all_yrs[[i]][[sheet_name]] = data_all_yrs[[i]][[sheet_name]] %>%
       mutate(
         "CTR_CD"= str_split(string = center,
                                        pattern = "[A-Z]{4}",
                                        n =2)[1],
         "CTR_TY" = str_split(string = center,
                                        pattern = "[A-Z]{4}",
                                        n =2)[2])
    }

  #data_all_yrs[[i]][["Tiers"]])
  
  # if str_match(name, "^Tbl") %>%
  #   mutate(
  #     CTR_CD = str_split(string = center, pattern = "[A-Z]{4}", n = 2)
  #   )
  # print(names(data_all_yrs[[i]]))
    
}


data_all_yrs[[i]][["Tbls B4-B5 & Fig B1-B6 - All"]]$CTR_CD

  print(names(data_all_yrs[[i]]))
  # sheet_names_list[[i]] = as_tibble(data_all_yrs[[i]] %>% names) %>%
  #   rename_with(~ paste("sheet_name")) %>%
  #   mutate("sheet_num" = 1:n()) %>%
  #   pivot_wider(
  #     names_from = sheet_num, 
  #     names_prefix = "sheet_", 
  #     values_from = sheet_name)
  # names(sheet_names_list) = names(data_all_yrs)

}
```

```{r check_cols_match}

# combine the wait list info (Sheet Table 1 or B1) across years
# first make sure the columns match - sheet names changed in 2014 and 11/2017

col_names_list = list()
sheet_names_list = list()

for (i in 1:length(data_all_yrs)) {
  
  sheet_names_list[[i]] = as_tibble(data_all_yrs[[i]] %>% names) %>%
    rename_with(~ paste("sheet_name")) %>%
    mutate("sheet_num" = 1:n()) %>%
    pivot_wider(
      names_from = sheet_num, 
      names_prefix = "sheet_", 
      values_from = sheet_name)
  names(sheet_names_list) = names(data_all_yrs)
  
  # make sure that the sheets contain the same columns
  for (sheet_i in 1:length(data_all_yrs[[i]])) {
    col_names_list[[i]] = as_tibble(data_all_yrs[[i]][[sheet_i]] %>% names) %>%
    rename_with(~ paste("value_name")) %>%
    mutate(
      # name the first column for the old files to match the recent ones
      value_name = str_replace(value_name, pattern = "...1", replacement = "ENTIRE_NAME"), 
      "col_num" = 1:n()) %>%
    pivot_wider(names_from = col_num, 
                names_prefix = "col_", 
                values_from = value_name))
    
    names(col_names_list) = (as.character(sheet_i)data_all_yrs[[i]] %>% names)
    
    if (sheet_i == length(data_all_yrs[[i]])) {
      col_names_df = bind_rows(col_names_list)
    }
    
  }
  
  if (i == length(data_all_yrs)) {
    sheet_names_df = bind_rows(sheet_names_list)
    col_names_df = bind_rows(col_names_list)
  }
}

if ((col_names_df %>% unique() %>% nrow() != 1) | (sheet_names_df %>% unique() %>% nrow() != 1)) {
  stop("Column names and sheet names are not the same across sheets, check data again")
}

# make a quick dictionary of column names for table1/B1
col_def_list = as.list(slice(data_all_yrs[[1]][[1]], n = 1))
names(col_def_list) = (as.character(col_names_df[1,]))

# bind the rows together
#map(.x = data_all_yrs, grab_sheet_1)

col_names_df
sheet_names_df


as_tibble(t(sapply(data_all_yrs, c))[1,])
```

Selecting only data of interest

```{r}
<<<<<<< HEAD

id_cols = c("CTR_ID", "CTR_CD", "RELEASE_DATE")

waitlist_cols = c("WLA_ADDCEN_NC2", "WLA_ST_NC2", "WLA_END_NC2", "WLA_REMTXC_NC2", "WLA_REMTXL_NC2", "WLA_REMTXC_PCZ", "WLA_REMTXL_PCZ", "WLA_REMDIED_PCZ", "WLA_REMDET_PCZ")

# CTR_CD, WLA_ADDCEN_NC2, WLA_ST_NC2, WLA_END_NC2, WLA_REMTXC_NC2, WLA_REMTXL_NC2, WLA_REMTXC_PCZ, WLA_REMTXL_PCZ, WLA_REMDIED_PCZ, WLA_REMDET_PCZ


=======
>>>>>>> kk3154
t1_function = function(df) {
  tbl1 = as_tibble(df[[1]]) %>% 
    select(1, any_of(id_cols), all_of(waitlist_cols))
  tbl1
}

t2_function = function(df) {
  tbl2 = as_tibble(df[[2]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, 
           WLC_A2_ALLC2, WLC_A10_ALLC2, WLC_A17_ALLC2, WLC_A34_ALLC2, WLC_A49_ALLC2, WLC_A64_ALLC2, WLC_GM_ALLC2, WLC_GF_ALLC2, WLC_RA_ALLC2, WLC_RB_ALLC2, WLC_RH_ALLC2, WLC_RO_ALLC2, WLC_RU_ALLC2, WLC_RW_ALLC2, WLC_PRA80_ALLC2, WLC_PTXY_ALLC2, WLC_KIDIA_ALLC2, WLC_KIGLO_ALLC2, WLC_KIHYP_ALLC2, WLC_KIMIS_ALLC2, WLC_KINEO_ALLC2, WLC_KIOTH_ALLC2, WLC_KIPOL_ALLC2, WLC_KIREN_ALLC2, WLC_KIRTR_ALLC2, WLC_KITUB_ALLC2, WLC_KICON_ALLC2)
  tbl2
}

t3_function = function(df) {
  if (length(df) <= 30) {tbl3 = as_tibble(df[[22]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, TOC_SHR_C, TOC_WKDIALY_C)}
  else if (length(df) == 32) {tbl3 = as_tibble(df[[23]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, TOC_SHR_C, TOC_WKDIALY_C)}
  else if (length(df) == 33) {tbl3 = as_tibble(df[[25]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, TOC_SHR_C, TOC_WKDIALY_C)}
  else if (length(df) == 34) {tbl3 = as_tibble(df[[26]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, TOC_SHR_C, TOC_WKDIALY_C)}
  tbl3
}

t4_function = function(df) {
  if (length(df) < 32) {tbl4 = as_tibble("")}
  if (length(df) == 32) {tbl4 = as_tibble(df[[16]]) %>% 
    select(1, CTR_CD, OA_OVERALL_HR_MN_CENTER, OA_LOWRISK_HR_MN_CENTER, OA_MEDIUMRISK_HR_MN_CENTER, OA_HIGHRISK_HR_MN_CENTER)}
  else if (length(df) == 33) {tbl4 = as_tibble(df[[18]]) %>% 
    select(1, CTR_CD, OA_OVERALL_HR_MN_CENTER, OA_LOWRISK_HR_MN_CENTER, OA_MEDIUMRISK_HR_MN_CENTER, OA_HIGHRISK_HR_MN_CENTER)}
  else if (length(df) == 34) {tbl4 = as_tibble(df[[19]]) %>% 
    select(1, CTR_CD, OA_OVERALL_HR_MN_CENTER, OA_LOWRISK_HR_MN_CENTER, OA_MEDIUMRISK_HR_MN_CENTER, OA_HIGHRISK_HR_MN_CENTER)}  
  tbl4
}

<<<<<<< HEAD


wl_tx_counts = map(subset_test2, t1_function)

  


wl_demo = map(data_all_yrs, t2_function)
tx_out = map(data_all_yrs, t3_function)
ctr_oar = map(data_all_yrs, t4_function)
=======
t5_function = function(df) {
  if (length(df) < 33) {tbl5 = as_tibble(df[[15]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, TTT_25_C, TTT_50_C, TTT_75_C)}
  if(length(df) == 33) {tbl5 = as_tibble(df[[17]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, TTT_25_C, TTT_50_C, TTT_75_C)}
  if(length(df) == 34) {tbl5 = as_tibble(df[[18]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, TTT_25_C, TTT_50_C, TTT_75_C)}
  tbl5
}

t6_function = function(df) {
  if (length(df) < 32) {tbl6 = as_tibble(df[[16]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, RCC_A2_C, RCC_A10_C, RCC_A17_C, RCC_A34_C, RCC_A49_C, RCC_A64_C, RCC_GM_C, RCC_GF_C, RCC_BAB_C, RCC_BA_C, RCC_BB_C, RCC_BO_C, RCC_BMI20_C, RCC_BMI25_C, RCC_BMI30_C, RCC_DIA_C, RCC_GLO_C, RCC_HYP_C, RCC_MIS_C, RCC_NEO_C, RCC_OTK_C, RCC_POL_C, RCC_VAS_C, RCC_RET_C, RCC_TUB_C, RCC_CON_C, RCC_PRA80_C, RCC_PTXY_C)}
  else if (length(df) == 32) {tbl6 = as_tibble(df[[17]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, RCC_A2_C, RCC_A10_C, RCC_A17_C, RCC_A34_C, RCC_A49_C, RCC_A64_C, RCC_GM_C, RCC_GF_C, RCC_BAB_C, RCC_BA_C, RCC_BB_C, RCC_BO_C, RCC_BMI20_C, RCC_BMI25_C, RCC_BMI30_C, RCC_DIA_C, RCC_GLO_C, RCC_HYP_C, RCC_MIS_C, RCC_NEO_C, RCC_OTK_C, RCC_POL_C, RCC_VAS_C, RCC_RET_C, RCC_TUB_C, RCC_CON_C, RCC_PRA80_C, RCC_PTXY_C)}
  else if (length(df) == 33) {tbl6 = as_tibble(df[[19]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, RCC_A2_C, RCC_A10_C, RCC_A17_C, RCC_A34_C, RCC_A49_C, RCC_A64_C, RCC_GM_C, RCC_GF_C, RCC_BAB_C, RCC_BA_C, RCC_BB_C, RCC_BO_C, RCC_BMI20_C, RCC_BMI25_C, RCC_BMI30_C, RCC_DIA_C, RCC_GLO_C, RCC_HYP_C, RCC_MIS_C, RCC_NEO_C, RCC_OTK_C, RCC_POL_C, RCC_VAS_C, RCC_RET_C, RCC_TUB_C, RCC_CON_C, RCC_PRA80_C, RCC_PTXY_C)}
  else if (length(df) == 34) {tbl6 = as_tibble(df[[20]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, RCC_A2_C, RCC_A10_C, RCC_A17_C, RCC_A34_C, RCC_A49_C, RCC_A64_C, RCC_GM_C, RCC_GF_C, RCC_BAB_C, RCC_BA_C, RCC_BB_C, RCC_BO_C, RCC_BMI20_C, RCC_BMI25_C, RCC_BMI30_C, RCC_DIA_C, RCC_GLO_C, RCC_HYP_C, RCC_MIS_C, RCC_NEO_C, RCC_OTK_C, RCC_POL_C, RCC_VAS_C, RCC_RET_C, RCC_TUB_C, RCC_CON_C, RCC_PRA80_C, RCC_PTXY_C)}
  tbl6
}

t7_function = function(df) {
  if (length(df) < 32) {tbl7 = as_tibble(df[[18]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, RCL_A2_C, RCL_A10_C, RCL_A17_C, RCL_A34_C, RCL_A49_C, RCL_A64_C, RCL_GM_C, RCL_GF_C, RCL_BAB_C, RCL_BA_C, RCL_BB_C, RCL_BO_C, RCL_BMI20_C, RCL_BMI25_C, RCL_BMI30_C, RCL_DIA_C, RCL_GLO_C, RCL_HYP_C, RCL_MIS_C, RCL_NEO_C, RCL_OTK_C, RCL_POL_C, RCL_VAS_C, RCL_KIRET_C, RCL_TUB_C, RCL_CON_C, RCL_PRA80_C, RCL_PTXY_C)}
  else if (length(df) == 32) {tbl7 = as_tibble(df[[19]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, RCL_A2_C, RCL_A10_C, RCL_A17_C, RCL_A34_C, RCL_A49_C, RCL_A64_C, RCL_GM_C, RCL_GF_C, RCL_BAB_C, RCL_BA_C, RCL_BB_C, RCL_BO_C, RCL_BMI20_C, RCL_BMI25_C, RCL_BMI30_C, RCL_DIA_C, RCL_GLO_C, RCL_HYP_C, RCL_MIS_C, RCL_NEO_C, RCL_OTK_C, RCL_POL_C, RCL_VAS_C, RCL_KIRET_C, RCL_TUB_C, RCL_CON_C, RCL_PRA80_C, RCL_PTXY_C)}
  else if (length(df) == 33) {tbl7 = as_tibble(df[[21]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, RCL_A2_C, RCL_A10_C, RCL_A17_C, RCL_A34_C, RCL_A49_C, RCL_A64_C, RCL_GM_C, RCL_GF_C, RCL_BAB_C, RCL_BA_C, RCL_BB_C, RCL_BO_C, RCL_BMI20_C, RCL_BMI25_C, RCL_BMI30_C, RCL_DIA_C, RCL_GLO_C, RCL_HYP_C, RCL_MIS_C, RCL_NEO_C, RCL_OTK_C, RCL_POL_C, RCL_VAS_C, RCL_KIRET_C, RCL_TUB_C, RCL_CON_C, RCL_PRA80_C, RCL_PTXY_C)}
  else if (length(df) == 34) {tbl7 = as_tibble(df[[22]]) %>% 
    select(1, CTR_CD, RELEASE_DATE, RCL_A2_C, RCL_A10_C, RCL_A17_C, RCL_A34_C, RCL_A49_C, RCL_A64_C, RCL_GM_C, RCL_GF_C, RCL_BAB_C, RCL_BA_C, RCL_BB_C, RCL_BO_C, RCL_BMI20_C, RCL_BMI25_C, RCL_BMI30_C, RCL_DIA_C, RCL_GLO_C, RCL_HYP_C, RCL_MIS_C, RCL_NEO_C, RCL_OTK_C, RCL_POL_C, RCL_VAS_C, RCL_KIRET_C, RCL_TUB_C, RCL_CON_C, RCL_PRA80_C, RCL_PTXY_C)}
  tbl7
}

t8_function = function(df) {
  if (length(df) < 33) {tbl8 = as_tibble(df[[5]]) %>% 
    select(CTR_CD, RELEASE_DATE, TMR_TXR_C2, TMR_TXRATIO_C2, TMR_CADTXR_C2, TMR_CADTXRATIO_C2, TMR_DTHR_C2, TMR_DTHRATIO_C2)}
  else if (length(df) >= 33) {tbl8 = as_tibble(df[[5]]) %>% 
    select(CTR_CD = substr(df$center, 1, 4), RELEASE_DATE, TMR_TxR_c, TMR_TxRatio_c, TMR_CadTxR_c, TMR_CadTxRatio_c, TMR_DthR_c, TMR_DthRatio_c)}
  tbl8
}

wl_tx_counts = map(data_all_yrs, t1_function)
wl_demo = map(data_all_yrs, t2_function)
tx_out = map(data_all_yrs, t3_function)
ctr_oar = map(data_all_yrs, t4_function)
ttt = map(data_all_yrs, t5_function)
ddtx_demo = map(data_all_yrs, t6_function)
ldtx_demo = map(data_all_yrs, t7_function)
wl_out = map(data_all_yrs, t8_function)
>>>>>>> kk3154
```
