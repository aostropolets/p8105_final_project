---
title: "SRTR Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(viridis)
library(purrr)
## Loading required package: viridisLite
library(plotly)
library(shiny)
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
suffix = list("age","gender","demographics")

for (i in suffix){
  data_path = "./data/"   # path to the data
  files = dir(data_path, 
              pattern = paste0("csrs_final_tables_2006_[A-Z][A-Z]_", i,".csv"))
  assign(paste0("df_all_", i),
         files %>%
           map(~ read_csv(file.path(data_path, .))%>%
                 mutate(org = str_replace(org, "HR", "Heart"),
                        org = str_replace(org, "HL", "Heart-Lung"),
                        org = str_replace(org, "IN", "Intestine"),
                        org = str_replace(org, "KI", "Kidney"),
                        org = str_replace(org, "KP", "Kidney-Pancreas"),
                        org = str_replace(org, "LI", "Liver"),
                        org = str_replace(org, "LU", "Lung"),
                        org = str_replace(org, "PA", "Pancreas"))) %>%
           reduce(rbind))
  }

organ_race = df_all_demographics %>% distinct(org) %>% pull()
organ_age = df_all_age %>% distinct(org) %>% pull()
organ_gender = df_all_gender %>% distinct(org) %>% pull()

# selectInput widget
selectInput(
  "organ_race", 
  label = h3("Select race of organ donor"),
  choices = organ_race, selected = "Kidney")

# selectInput widget
selectInput(
  "organ_age", 
  label = h3("Select age of organ donor"),
  choices = organ_gender, selected = "Kidney")

# selectInput widget
selectInput(
  "organ_gender", 
  label = h3("Select gender of organ donor"),
  choices = organ_gender, selected = "Kidney")
```

Column {data-width=650}
-----------------------------------------------------------------------

### Race (Percent) by Zipcode

```{r}

# renderPrint({ 
#   input[["organ_race"]]
# })

renderPlotly({
  df_all_demographics %>%
    rename(Race = race_category_percent, Zipcode = zipcode) %>%
    mutate(race_category =
             str_replace(race_category, "african_american_allc2", "African American"),
           race_category =
             str_replace(race_category, "asian_allc2", "Asian"),
           race_category =
             str_replace(race_category, "hispanic_latino_allc2", "Hispanic or Latino"),
           race_category =
             str_replace(race_category, "race_other_allc2", "Other"),
           race_category = str_replace(race_category, "race_unknown_allc2", "Unknown"),
           race_category = str_replace(race_category, "white_allc2", "White")) %>%
    filter(organ_race == input$organ_race) %>%
    plot_ly(x = ~Zipcode, y = ~Race, 
            type = "scatter", mode = "markers",
            alpha = 0.9, color = ~race_category)})
```

Column {data-width=350}
-----------------------------------------------------------------------

### Age Group (Percent) by Zipcode

```{r}
# renderPrint({ 
#   input[["organ_age"]]
# })
renderPlotly({
  df_all_age  %>%
    mutate(
      age_category = str_replace(age_category, "age_2_allc2", "Less Than 2 Years"),
      age_category = str_replace(age_category, "age_2_11_allc2", "2 to 11 Years"),
      age_category = str_replace(age_category, "age_12_17_allc2", "12 to 17 Years"),
      age_category = str_replace(age_category, "age_18_34_allc2", "18 to 34 Years"),
      age_category = str_replace(age_category,"age_35_49_allc2", "35 to 49 Years"),
      age_category = str_replace(age_category, "age_50_64_allc2", "50 to 64 Years"),
      age_category = str_replace(age_category, "age_65_69_allc2", "65 to 69 Years"),
      age_category = str_replace (age_category, "age_70_allc2", "More Than 70 Years"),
      age_category = factor(age_category, 
                            levels = c("Less Than 2 Years","2 to 11 Years",
                                       "12 to 17 Years", "18 to 34 Years", 
                                       "35 to 49 Years", "50 to 64 Years",
                                       "65 to 69 Years", "More Than 70 Years"))) %>%
    rename(Age_Group = age_category_percent, Zipcode = zipcode) %>%
    filter(organ_age == input$organ_age) %>%
    plot_ly(x = ~Zipcode, y = ~Age_Group, 
            type = "scatter", mode = "markers",
            alpha = 0.9, color = ~age_category)})
```

### Gender (Percent) by Zipcode

```{r}
# renderPrint({ 
#   input[["organ_gender"]]
# })

renderPlotly({
  df_all_gender %>%
    rename(Gender = gender_category_percent, Zipcode = zipcode) %>%
    mutate(gender_category = str_replace(gender_category, "female_allc2", "Female"),
           gender_category = str_replace(gender_category, "male_allc2", "Male")) %>%
    filter(
    organ_gender == input$organ_gender) %>%
    plot_ly(x = ~Zipcode, y = ~Gender, 
            type = "scatter", mode = "markers",
            alpha = 0.9, color = ~gender_category)})
```